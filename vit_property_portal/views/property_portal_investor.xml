<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_asset_overview" name="Aset Investor">
        <t t-call="portal.portal_layout">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h4 class="fw-bold mb-1">Ikhtisar Aset</h4>
                        <p class="text-muted mb-0">
                            Ringkasan portofolio investasi properti Anda
                        </p>
                    </div>
                    <a href="/properties" class="btn btn-outline-primary px-4">
                        <i class="fa fa-plus me-2"></i>Tambah Investasi
                    </a>
                </div>
                <hr/>

                <div class="row g-4">
                    <div class="col-lg-4 col-md-6">
                        <div class="card h-100 rounded-4">
                            <div class="card-body p-4 d-flex flex-column justify-content-between">
                                <div>
                                    <p class="text-primary text-uppercase small mb-2">Saldo Saya</p>
                                    <h3 class="fw-bold text-success mb-0">
                                        <t t-esc="user_balance_currency or 0" t-options="{'widget': 'monetary', 'display_currency': user.currency_id}"/>
                                    </h3>
                                </div>
                                <button class="btn btn-success w-100 mt-4 py-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                                    Tarik Dana
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-6">
                        <div class="card h-100 rounded-4">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-muted">Nilai Akun Saat Ini</span>
                                    <span class="fw-bold text-success">
                                        <t t-esc="current_account_value or 0" t-options="{'widget': 'monetary', 'display_currency': user.currency_id}"/>
                                    </span>
                                </div>
                                <hr class="my-3"/>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Investasi Awal</span>
                                    <span class="fw-semibold text-dark">
                                        <t t-esc="investasi_awal or 0" t-options="{'widget': 'monetary', 'display_currency': user.currency_id}"/>
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Total Sewa Diperoleh</span>
                                    <span class="fw-semibold text-dark">
                                        <t t-esc="total_rent_income or 0" t-options="{'widget': 'monetary', 'display_currency': user.currency_id}"/>
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Token</span>
                                    <span class="fw-semibold text-dark">
                                        <t t-esc="token_awal or 0" /> + <t t-esc="token_count or 0" />
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Properti Dimiliki</span>
                                    <span class="fw-semibold text-dark">
                                        <t t-esc="owned_property_count or 0"/>
                                    </span>
                                </div>
                                <a href="/investor/nilai_akun" class="btn btn-outline-info w-100 mt-3 py-2">
                                    Lihat Detail
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-12">
                        <div class="card h-100 rounded-4 bg-light">
                            <div class="card-body p-4 d-flex flex-column justify-content-center text-center">
                                <h5 class="fw-bold mb-3 text-primary">Optimalkan Portofolio Anda</h5>
                                <p class="text-muted mb-4">
                                    Diversifikasi investasi untuk pertumbuhan jangka panjang dan risiko minimal.
                                </p>
                                <a href="/properties" class="btn btn-outline-primary px-4">
                                    Lihat Rekomendasi
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Penarikan Dana -->
            <div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 border-0 shadow">
                        <div class="modal-header border-0">
                            <h5 class="modal-title fw-bold text-success" id="withdrawModalLabel">Form Penarikan Dana</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="withdrawForm" t-att-action="'/investor/payment_request'" method="post">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <div class="mb-3">
                                    <label for="property_unit_id" class="form-label fw-semibold">Pilih Properti</label>
                                    <select class="form-select rounded-3" name="property_unit_id" id="property_unit_id" required="True">
                                        <option value="">Pilih Properti</option>
                                        <t t-foreach="invested_properties" t-as="p">
                                            <option t-att-value="p.property_unit_id.id">
                                                <t t-esc="p.property_unit_id.name"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="token_amount" class="form-label fw-semibold">Jumlah Token</label>
                                    <input type="number" min="1" step="1" name="token_amount" id="token_amount" class="form-control rounded-3" placeholder="Masukkan jumlah token" required="True"/>
                                </div>
                                <div class="mb-3">
                                    <label for="bank_account" class="form-label fw-semibold">Rekening Bank Tujuan</label>
                                    <select class="form-select rounded-3" name="bank_account" id="bank_account" required="True">
                                        <option value="">Pilih Rekening Bank</option>
                                        <t t-foreach="user.partner_id.bank_ids" t-as="b">
                                            <option t-att-value="b.id">
                                                <t t-esc="b.bank_name"/> - <t t-esc="b.acc_number"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success btn-lg rounded-3">
                                        Ajukan Penarikan
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer border-0 text-muted text-center small">
                            Proses penarikan memerlukan verifikasi dan mungkin memakan waktu 1â€“2 hari kerja.
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="nilai_akun_table" name="Ikhtisar Nilai Akun">
        <t t-call="portal.portal_layout">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <span class="fw-bold">Detail Nilai Akun</span>
                            </div>
                            <div class="card-body">
                                <table class="table table-striped table-hover table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center">Property</th>
                                            <th class="text-center">Transaksi</th>
                                            <th class="text-center">Token Awal</th>
                                            <th class="text-center">Jumlah Investasi</th>
                                            <th class="text-center">Profit</th>
                                            <th class="text-center">Token Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-if="rows">
                                            <t t-foreach="rows" t-as="r">
                                                <tr>
                                                    <td><t t-esc="r['property_name']"/></td>
                                                    <td><t t-esc="r['transaksi']"/></td>
                                                    <td class="text-center"><t t-esc="r['token']"/></td>
                                                    <td class="text-end">
                                                    <t t-esc="r['jumlah_investasi']"
                                                        t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                                    </td>
                                                    <td class="text-end">
                                                    <t t-esc="r['profit']"
                                                        t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                                    </td>
                                                    <td class="text-center"><t t-esc="r['token_profit']"/></td>
                                                </tr>
                                            </t>
                                        </t>
                                        <t t-else="">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    Belum ada data investasi
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>

                                <hr/>
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <h6 class="fw-bold mb-3">Summary</h6>
                                        <div class="row text-center">
                                            <div class="col-md-3 col-6 mb-2">
                                                <div class="fw-semibold">Total Token Awal</div>
                                                <div class="fw-bold">
                                                    <t t-esc="summary['total_token']"/>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-2">
                                                <div class="fw-semibold">Total Investasi</div>
                                                <div class="fw-bold">
                                                    <t t-esc="summary['total_investasi']"
                                                    t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-2">
                                                <div class="fw-semibold">Total Profit</div>
                                                <div class="fw-bold text-success">
                                                    <t t-esc="summary['total_profit']"
                                                    t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-2">
                                                <div class="fw-semibold">Total Token Profit</div>
                                                <div class="fw-bold">
                                                    <t t-esc="summary['total_token_profit']"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr class="my-3"/>
                                <div class="text-center">
                                    <h5 class="fw-bold mb-1">Total Saldo</h5>
                                    <h4 class="fw-bold text-success">
                                        <t t-esc="summary['total_saldo']" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                    </h4>
                                </div>

                                <div class="mt-4">
                                    <h5 class="fw-bold mb-3">Detail Token per Properti</h5>
                                    <div class="accordion" id="tokenAccordion">
                                        <t t-foreach="property_tokens_map.values()" t-as="pt">
                                            <t t-set="slug" t-value="pt['property_name'].replace(' ', '-')"/>
                                            <div class="accordion-item mb-1 rounded">
                                                <h2 class="accordion-header" t-att-id="'heading-%s' % slug">
                                                    <button class="accordion-button collapsed fw-semibold" type="button" 
                                                        data-bs-toggle="collapse" 
                                                        t-att-data-bs-target="'#collapse-%s' % slug"
                                                        aria-expanded="false" 
                                                        t-att-aria-controls="'collapse-%s' % slug">
                                                        <i class="fa fa-building me-2 text-primary"></i>
                                                        <t t-esc="pt['property_name']"/>
                                                    </button>
                                                </h2>
                                                <div class="accordion-collapse collapse" 
                                                    t-att-id="'collapse-%s' % slug" 
                                                    t-att-aria-labelledby="'heading-%s' % slug" 
                                                    data-bs-parent="#tokenAccordion">
                                                    
                                                    <div class="accordion-body">
                                                        <!-- Tombol Resell -->
                                                        <div class="mb-2 mt-2">
                                                            <button class="btn btn-primary"
                                                                data-bs-toggle="modal"
                                                                t-att-data-bs-target="'#resellPropertyModal-%s' % pt['property_id']">
                                                                <i class="fa fa-dollar-sign me-1"></i> Jual Token
                                                            </button>
                                                        </div>

                                                        <div class="alert-container" id="alert-container"></div>

                                                        <!-- Tabel Token -->
                                                        <table class="table table-striped table-sm table-hover align-middle mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th class="text-center">Token Code</th>
                                                                    <th class="text-center">Status</th>
                                                                    <th class="text-center">Price per Token</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <t t-foreach="pt['tokens']" t-as="token" t-key="token.id">
                                                                    <tr>
                                                                        <td class="text-center">
                                                                            <span class="badge bg-info">
                                                                                <t t-esc="token.token_code"/>
                                                                            </span>
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <t t-if="token.token_state == 'available'">
                                                                                <span class="badge bg-info">Available</span>
                                                                            </t>
                                                                            <t t-elif="token.token_state == 'reserved'">
                                                                                <span class="badge bg-warning text-dark">Reserved</span>
                                                                            </t>
                                                                            <t t-else="">
                                                                                <span class="badge bg-success">Sold</span>
                                                                            </t>
                                                                        </td>
                                                                        <td class="text-end">
                                                                            <t t-esc="token.property_unit_id.price_per_token"
                                                                                t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                                                        </td>
                                                                    </tr>
                                                                </t>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Modal Resell -->
                                            <div class="modal fade" t-att-id="'resellPropertyModal-%s' % pt['property_id']" tabindex="-1" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered">
                                                    <div class="modal-content">
                                                        <div class="modal-header bg-primary text-white">
                                                            <h5 class="modal-title">Resell Token - <t t-esc="pt['property_name']"/></h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form class="resell-property-form" t-att-data-property-id="pt['property_id']">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Jumlah Token yang ingin dijual</label>
                                                                    <input type="number" name="qty_token" class="form-control" min="1" t-att-max="pt['total_token']" required="True" />
                                                                    <small class="text-muted">Anda memiliki <t t-esc="pt['total_token']"/> token</small>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Harga per Token</label>
                                                                    <input type="number" name="price_per_token" class="form-control" step="1000" required="True"/>
                                                                </div>
                                                                <div class="text-end">
                                                                    <button type="submit" class="btn btn-success">
                                                                        <i class="fa fa-paper-plane me-1"></i> Ajukan Resell
                                                                    </button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
